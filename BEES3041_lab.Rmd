---
title: "BEES3041: Modelling the photosynthetic response to environmental conditions"
output:
  pdf_document: default
  html_notebook: default
  number_sections: TRUE
  code_folding: hide
bibliography: data/bibliography.bib
---

```{r logo, echo=FALSE, out.width = '30%'}
knitr::include_graphics("data/logo.jpeg")
```

# Introduction

In this lab we are going to explore the C~3~ leaf-level photosynthesis model proposed by @Far80 and use this to simulate photosynthesis at leaf, ecosystem and global scales. The model is central to all land schemes embedded in coupled-climate models and predicts that photosynthesis is limited by the slowest of three biochemical processes: 

  1. Maximum rate of Rubisco-catalysed carboxylation
  2. Rate of ribulose 1,5-bisphosphate (RuBP) regeneration via electron transport 
  3. The rate of RuBP regeneration via triose phosphate utilisation 

In this practical we are only going to consider the first two limitations. There a number of great papers which cover this subject in detail, see for example, @Ber13, @Med02 and @Sha85.

We are going to use the photosynthesis model to:

* learn how leaf-level photosynthesis responds to changes in the environmental forcing (photosynthetically active radiation, temperature and carbon dioxide).
* simulate GPP at the ecosystem-scale (~1 km^2) using FLUXNET (eddy covariance) meteorological data.
* build a simpler GPP model and apply this at the ecosystem scale.

From playing with these model across scales, we should start to see the key assumptions that our model makes. We should also begin to identify the key weakness in our approach as we apply the model at different scales. 

# Temperature responses of model parameters

Let's start by exploring the response of the model to temperature. First we need to generate some temperature data:

```{r}
library(ggplot2)

source("R/photosynthesis.R")
source("R/parameters.R")
source("R/constants.R")

# The model expects the temperature to be in Kelvin so we need to do a conversion
Tleaf <- seq(0.0, 50.0, 0.5) + DEG_2_KELVIN
```

The photosynthesis model has two major parameters, the potential rate of electron transport (Jmax) and the maximum rate of Rubisco activity (Vcmax). Both of these parameters vary as a function of temperature, let's plot them. I've copied the function calls from photosynthes.R:

```{r}
Vcmax <- peaked_arrh(p$Vcmax25, p$Eav, Tleaf, p$deltaSv, p$Hdv)
Jmax <- peaked_arrh(p$Jmax25, p$Eaj, Tleaf, p$deltaSj, p$Hdj)

df <- data.frame(Tleaf, Vcmax, Jmax)

ggplot(df, aes(Tleaf-DEG_2_KELVIN)) +
  geom_line(aes(y=Vcmax, colour="Vcmax")) +
  geom_line(aes(y=Jmax, colour="Jmax")) +
  ylab(expression("Paramater" ~ (mu * mol ~  m^{-2}  ~  s^{-1}))) +
  xlab(expression('Temperature ('*~degree*C*')')) + 
  theme_classic() +
  theme(legend.title=element_blank()) +
  scale_colour_brewer(palette = "Set2")
```

In the model both parameters are modelled using a peaked form of the Arrhenius equation. The Eav/Eaj parameters give the exponential increase of the function below the optimum; the Hdv/Hdj parameters describe the rate of decrease of the function above the optimum. 

In the model both parameters are modelled using a peaked form of the Arrhenius equation. The Eav/Eaj parameters give the exponential increase of the function below the optimum; the Hdv/Hdj parameters describe the rate of decrease of the function above the optimum. 

Q. Can you work out what values you used? 
Q. Can you now tweak these values and explore how the functions respond to temperature?

In the model, the Rubisco-limited photosynthesis rate is made up of five paramaters: 

  1. $\Gamma$$^{*}$: the CO~2~ compensation point in the absence of mitochondrial respiration.
  2. V~cmax~: the maximum rate of Rubisco activity.
  3. R~d~: leaf mitochondrial respiration in the light (day respiration).
  4. K~o~: Michaelis– Menten coefficients for oxygenation.
  5. K~c~: Michaelis– Menten coefficients for carboxylation.
  
Each of these parameters is temperature dependent, thus the skill of the model depends on correctly accounting for these response to temperature when using the model. When we use these model parameters in global models we typical assume that the parameters (excluding V~cmax~) are conserved across species. This assumption is broadly supported by observations.

Q. What do we think happens in different growing conditions? 

By contrast, leaf measurements suggest that V~cmax~ varies considerably: varying between leaves within a single plant, across growing seasons and across plants. In global models, we typically assume that we can represent this variability using 5-11 plant functional types, see @Rog14 for more details. Even when we do this in models, the disagreement across models is striking.

```{r rogers, echo=FALSE, out.width = '40%', fig.align = "center"}
knitr::include_graphics("data/rogers.png")
```

Q. What impact do you think this variability will have on model simulations of GPP? 
Q. Now that you've seen how to call the functions to calculate V~cmax~ and J~max~, can you look in the code (R/photosynthesis.R) and also plot $\Gamma$$^{*}$, R~d~m, K~o~ and K~m~ as a function of temperature?

***

# Response to temperature

Q. From your new understanding of how the key model parameters change with temperature, can you predict how the rate of photosynthesis is likely to change with temperature? 
Q. Can you make a plot to see if your prediction matched the models? (hint ... You will need to call the calc_photosynthesis function)

The plot shows the response of A to temperature increases steadily until it reaches an optimum point (T~opt~), after which A declines at a faster rate.

The model assumes that the Rubisco-limited assimilation rate follows a Michaelis–Menten response function, accounting for a competitive inhibitor, oxygen. With Michaelis-Menten reactions: (i) increasing the limiting substrate, CO~2~; (ii) the amount of enzyme present, Rubisc; and/or (iii)  decreasing the competitive inhibitor, O2, will yield higher reaction rates. The model also assumes that the RuBP regeneration-limited rate of assimilation depends on the rate at which the light reactions generate ATP and NADPH; this process is limited at low light intensity. 

Q. Can you increase and decrease the intercellular concentration of O2 parameter (Oi) and plot the impact. Does your plot fit with what I said above?
Q. Can you figure out how to test the other factors?

***

## Response to PAR

At low PAR, A is RUBP regeneration-limited due to the low rates of electron transport. The slope of the inital portion of the A/PAR curve is referred to as the quantum efficieicy of CO~2~ assimilation (see alpha parameter). As light increases, the rapid increase of A with PAR begins to diminsh. The rate this occurs at depends on what we assumed for the curvuture parameter (theta_J). 

Q. Can you vary PAR and plot the response of A (hint ... see how you made an array of temperature)?
Q. Can youexplore the sensitivity of the A-PAR relationship to alpha and theta_J parameters?

***

## Response to CO~2~

At low [CO~2~] concentrations, photosynthesis is Rubisco-limited except for when PAR is also low. With inceasing [CO~2~], A increases until an inflection point is reached where A is said to be co-limited by Rubisco and RuBP regeneration. 

Q. Can you vary [CO~2~] and plot the response of A?

***

## Response to global change

The plots you've made should have given you some insight into how photosynthesis will respond to changes in temperature and [CO~2~]. This is very powerful as it means you should now have a sense of what a climate model will simulate will happen to GPP in the future.

Q. Given your new insights, what do you predict will happen to carbon uptake [CO~2~] keeps increasing?
Q. What will happen in response to increasing temperature?
Q. Do you think there will be an interaction in response to increasing temperature and [CO~2~]?

You can probably also make an informed guess about some of the factors that we haven't accounted for in this model. 

Q. What does the photosynthesis model predict happens in a drought? 
Q. What happens to photosynthesis as the ozone concentration changes? 
Q. The model predicts and instantaneous response to temperature but what about acclimation to temperature? 

## Ecosystem scale

Let's now apply the leaf-level model at a coarser spatial scale and compare our model simulations to measured data. In doing so, try and keep in mind the assumptions we are making. Can we explain any model-data disagreements based on these.

To apply the leaf-level model at a km^2^ scale, we are going to use a big-leaf approximation to scale up our leaf-level model. We are going to assume that:

$$APAR = PAR * fPAR$$

where 

$$fPAR = (1.0 - exp(-k * LAI)) / k$$
and k=0.5.

Across the globe there is large network of sites (~900) with meteorological sensors measuring a range of variables (e.g. temperature, humidity, wind speed, rainfall) on a continuous basis. At each of these sites, the eddy covariance method is also used to measure the exchange of carbon dioxide, energy and water vapour fluxes between the vegetation and soils and the atmosphere. These data are freely avaliable at a number of sites (but not all!) under a release called FLUXNET2015 (https://fluxnet.fluxdata.org/).

The original data from FLUXNET aren't readily useable by land surface models. These data must be first transformed into a LSM-readable file format - [NetCDF](https://www.unidata.ucar.edu/software/netcdf/), apply some unit corrections and be screened and gap-filled, where necessary. Fortunately [Anna Ukkola at UNSW](https://www.ccrc.unsw.edu.au/ccrc-team/alumni/anna-ukkola) has done all the heavy lifting here, so we will data that has been corrected by her [R package](https://www.geosci-model-dev.net/10/3379/2017/). 

NetCDF files are the gold standard for the climate community as they are a self describing format that allows you to associate many layers of metadata with a binary file that wouldn't be possible with a text file. To be able to read these data we are going to have to use a NetCDF library and learn a few new commands...

```{r}
library(ncdf4)

fname <- "data/FR-Pue_2002-2003_FLUXNET2015_Met.nc"
f <- nc_open(fname)
head(f)
```

Let's query the lat and lon 
```{r}
lon <- ncvar_get(f, "longitude")
lat <- ncvar_get(f, "latitude")
print(c(lat,lon))
```


```{r}
t <- ncvar_get(f, "time")
time_from <- substr(ncatt_get(f, "time")$units, 15, 33)
time <- as.POSIXct(t, origin=time_from)
head(time)
```

Now let's extract the data we need to run our leaf model
```{r}
Tair <- ncvar_get(f, "Tair") 
```

Q. Can you get VPD and SWdown?

It is good practice to clean up when we're done with the NetCDF file.
```{r}
nc_close(f) 
```

It is a good idea to make a sanity plot at this point, garbage into a model leads to garbage out...

Q. Can you plot Tair for the first year (the timestep of the data is 30 mins)?

LSMs typically use SWdown, so we will need to convert this to PAR and for our big-leaf scaling we also need to transform this to APAR using the equations we outlined above.

```{r}
library(dplyr)

PAR <- SWdown * SW_2_PAR
k = 0.5
LAI = 1.5
fPAR <- (1.0 - exp(-k * LAI)) / k
APAR <- PAR * fPAR

# Let's just assume this
Cs <- 400.0

out <- calc_photosynthesis(p, Tleaf, APAR, Cs, vpd, peaked_Vcmax=TRUE,
                           peaked_Jmax=TRUE)
```

Plotting half-hourly output will be a bit much, so let's generate daily output
```{r}

# Let's convert from 30 mins to daily sums as these will be easier to view.
conv <- UMOL_TO_MOL * MOL_C_TO_GRAMS_C * SEC_2_HLFHR

# build a dataframe to ease manipulation
df <- data.frame(time, out$An)
colnames(df)<- c("time", "An") 

# Let's use the dplyr lib to aggregate to daily data
df_day <- df %>%
  mutate(day=as.Date(time, format="%Y-%m-%d")) %>%
  group_by(day) %>%               # group by the day column
  summarise(GPP=sum(An * conv))   # calculate the SUM of all the photosynthesis that occurred on each day
                                  # NB unit conversion
```

Q. Transforming the data from 30min to daily might be something we repeat, can you create a function to do this?
Q. Can you plot the model output?

OK we've now modelled some GPP based on real data, it is time to see how sensible our model simulation was! Let's compare the model output to the flux derived GPP. It is important to note that GPP isn't measured at flux sites, but is derived from other measurements; however, for the purposes of this practical you can view it is as a set of observations.

Q. Can you use the previous logic to load the flux file and extract the GPP variable and make a dataframe?
Q. Can you use your function to turn this dataframe into daily data?
Q. Can you plot the obs and the model?


Our simple model doesn't do that bad a job at simulating GPP at a larger scale, nevertheless there are some notable periods of divergence. 

Q. Why do you think the model underestimate GPP during the peak of summer? 
Q. Why do you think the model overestimates GPP after July?

***

## Can we make a simpler model of GPP?

In contrast to the complicated leaf photosynthesis model following Farquhar, we could use a much simpler light use efficiency (LUE) model to estimate GPP. The LUE model predicts that GPP is directly proportional to the absorbed PAR,.

$$GPP = \epsilon * fPAR * PAR$$

where $\epsilon$ is the light use efficiency constant. The LUE model originated from work by John Monteith. @Mon72 suggested that the NPP of well-watered and fertilized annual crop plants was linearly related to the amount of solar energy the plants absorbed over a growing season. In a follow up study, @Mon77 observed linear relationships between aboveground NPP and APAR for several different agricultural crops in Britain, leading him to suggest that $\epsilon$ was a conservative parameter. This approach is now used in combination with satellite data to model GPP at the global scale. In the MODIS algorithm, $\epsilon$ (emax below) varies by vegetation type and is reduces with temperature (temperature scalar) and water stress (via VPD scalar).

Let's generate a LUE, similar to the MODIS model and apply it at our flux site. 

```{r}
source("R/lue.R")

# PAR half of SW (W m-2 -> J m-2 s-1 -> MJ m-2 30 min-1)
conv <- 0.5 * J_TO_MJ * SEC_2_HLFHR

df <- data.frame(time, SWdown)
colnames(df)<- c("time", "PAR") 

# Let's use the dplyr lib to aggregate to daily data
df_par <- df %>%
  mutate(day=as.Date(time, format="%Y-%m-%d")) %>%
  group_by(day) %>%                  # group by the day column
  summarise(PAR=sum(PAR * conv))     # calculate the SUM 
                                     # NB unit conversion
```

Q. Can you do the same for vpd and Tair, taking the mean instead?
Q. Can you merge par, tair and tair into one dataframe?

Let's generate the LUE inputs and plot create a dataframe
```{r}
# Calculate temperature and vapour pressure deficit scalars, i.e. scale btw 0 and 1
T_scal <- (df$Tair - min(df$Tair)) / (max(df$Tair) - min(df$Tair))
D_scal <- (df$vpd - min(df$vpd)) / (max(df$vpd) - min(df$vpd))

# You should play with this value and see how your plot changes, can you predict
# the impact before you change this value?
emax <- 1.0 # g C m-2 MJ-1 APAR

GPP <- calc_lue(fPAR, df$PAR, T_scal, D_scal, emax)

df_lue <- data.frame(df_flx$day, GPP)
colnames(df_lue)<- c("day", "GPP_lue") 

df <- merge(df_flx, df_lue, by="day")
colnames(df)<- c("day", "GPP_obs", "GPP_mod", "GPP_lue") 
```

Q. Can you plot the obs, farquhar model and the LUE model on one plot?
Q. By comparing the simple LUE model with our more complicated model, can we spot any weaknesses in the model assumptions? 
Q. Why does the LUE have a much stronger seasonality? 
What assumption do you think drive this? 
Q. Can you test what you think the cause is by adjusting the LUE equation?
