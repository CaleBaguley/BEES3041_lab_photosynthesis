---
title: "BEES3041: Modelling the photosynthetic response to environmental conditions"
output:
  pdf_document: default
  html_notebook: default
  number_sections: TRUE
---

```{r pressure, echo=FALSE, out.width = '30%'}
knitr::include_graphics("data/logo.jpeg")
```

# Introduction

In this lab we will explore a leaf-level photosynthesis model (Farquhar et al. 1980), which is central to all land schemes embedded in coupled-climate models.

In this practical we are going to:

* to learn about how leaf-level photosynthesis, responds to changes in the environmental forcing (photosynthetically active radiation, temperature and carbon dioxide).
* we are going to apply this model to ecosystem-scale (~1 km^2) meteorological data and explore how well a leaf-level model can predict fluxes at a larger spatial scale.
* we are going to use our new insights to consider the key assumptions we are making with our model and identify the key weaknesses in our approach.

***

# Response to temperature

Let's start by exploring the response of the model to temperature. First we need to generate some temperature data:

```{r}
library(ggplot2)

source("R/photosynthesis.R")
source("R/parameters.R")
source("R/constants.R")

Tleaf <- seq(1, 50.0, 0.5) + DEG_2_KELVIN
```

The photosynthesis model has two major parameters, the potential rate of electron
transport (Jmax) and the maximum rate of Rubisco activity (Vcmax). Both of these parameters vary as a function of temperature, let's plot them. I've copied the function calls from photosynthes.R:

```{r}
Vcmax <- peaked_arrh(p$Vcmax25, p$Eav, Tleaf, p$deltaSv, p$Hdv)
Jmax <- peaked_arrh(p$Jmax25, p$Eaj, Tleaf, p$deltaSj, p$Hdj)

df <- data.frame(Tleaf, Vcmax, Jmax)

ggplot(df, aes(Tleaf-DEG_2_KELVIN)) +
  geom_line(aes(y=Vcmax, colour="Vcmax")) +
  geom_line(aes(y=Jmax, colour="Jmax")) +
  ylab(expression("Paramater" ~ (mu * mol ~  m^{-2}  *  s^{-1}))) +
  xlab(expression('Temperature ('*~degree*C*')')) + 
  theme_classic() +
  theme(legend.title=element_blank()) +
  scale_colour_brewer(palette = "Set2")

```

In the model both parameters are modelled using a peaked form of the Arrhenius equation. The Eav/Eaj parameters give the exponential increase of the function below the optimum; the Hdv/Hdj parameters describe the rate of decrease of the function above the optimum. 

Let's see what values we used:  

```{r}
print(c(p$Vcmax25, p$Eav, p$deltaSv, p$Hdv))
print(c(p$Jmax25, p$Eaj, p$deltaSj, p$Hdj))
```

Let's tweak these values and see how our functions respond to temperature changes

```{r}
Vcmax <- peaked_arrh(p$Vcmax25, p$Eav, Tleaf, p$deltaSv, p$Hdv)
Vcmax2 <- peaked_arrh(p$Vcmax25, 40000, Tleaf, 620.0, p$Hdv)
Vcmax3 <- peaked_arrh(p$Vcmax25, 70000, Tleaf, 650.0, p$Hdv)


df <- data.frame(Tleaf, Vcmax, Jmax)

ggplot(df, aes(Tleaf-DEG_2_KELVIN)) +
  geom_line(aes(y=Vcmax, colour="Vcmax")) +
  geom_line(aes(y=Vcmax2, colour="Vcmax2")) +
  geom_line(aes(y=Vcmax3, colour="Vcmax3")) +
  ylab(expression("Vcmax" ~ (mu * mol ~  m^{-2}  *  s^{-1}))) +
  xlab(expression('Temperature ('*~degree*C*')')) + 
  theme_classic() +
  theme(legend.title=element_blank()) +
  scale_colour_brewer(palette = "Set2")
```

From this understanding of how the two key model parameters change with temperature, can we make a prediction about how the rate of photosynthesis is likely to change with temperature (i.e. between 0 and 50 degrees?)? 

Let's make a plot to see if our predictions matched the models...

```{r}

PAR <- 1800.0
Cs <- 400.
vpd <- 1.5

out <- calc_photosynthesis(p, Tleaf, PAR, Cs, vpd, peaked_Vcmax=TRUE,
                           peaked_Jmax=TRUE)

df <- data.frame(Tleaf, out$An, out$Ac, out$Aj)

ggplot(df, aes(Tleaf-DEG_2_KELVIN)) +
  geom_line(aes(y=out.An, colour="An")) +
  geom_line(aes(y=out.Ac, colour="Rubisco-limited (Ac)")) +
  geom_line(aes(y=out.Aj, colour="RuBP-limited (Aj)")) +
  ylab(expression("Photosynthesis" ~ (mu * mol ~  m^{-2}  *  s^{-1}))) +
  xlab(expression('Temperature ('*~degree*C*')')) + 
  theme_classic() +
  theme(legend.title=element_blank()) +
  scale_colour_brewer(palette = "Set2")
```



***

## Response to PAR

***

## Response to CO~2~

***

## Flux stuff

***

## Global predictions























Let's get some CO2 data to run the model with

```{r}
mauna_loa_co2 <- read.table('ftp://aftp.cmdl.noaa.gov/products/trends/co2/co2_annmean_mlo.txt')
names(mauna_loa_co2) <- c('year', 'co2ppm', 'unc')

ggplot(mauna_loa_co2, aes(year, co2ppm)) +
  geom_line() +
  ylab("CO2 (ppm)") +
  xlab('Year') + 
  theme_classic()
```


