---
title: "BEES3041: Modelling the photosynthetic response to environmental conditions"
output:
  pdf_document: default
  html_notebook: default
  number_sections: TRUE
---

```{r logo, echo=FALSE, out.width = '30%'}
knitr::include_graphics("data/logo.jpeg")
```

# Introduction

In this lab we are going to explore the C~3~ leaf-level photosynthesis model proposed by Farquhar et al. (1980) and use this to simulate photosynthesis at leaf, ecosystem and global scales. The model is central to all land schemes embedded in coupled-climate models and predicts that photosynthesis is limited by the slowest of three biochemical processes: 

  1. Maximum rate of Rubisco-catalysed carboxylation
  2. Rate of ribulose 1,5-bisphosphate (RuBP) regeneration via electron transport 
  3. The rate of RuBP regeneration via triose phosphate utilisation 

In this practical we are only going to consider the first two limitations. 

We are going to use this model to:

* learn how leaf-level photosynthesis responds to changes in the environmental forcing (photosynthetically active radiation, temperature and carbon dioxide).
* simulate GPP at the ecosystem-scale (~1 km^2) using FLUXNET (eddy covariance) meteorological data.
* simulate a global estimate of GPP.

From playing with this model across scales, we should start to see the key assumptions that our model makes. We should also begin to identify the key weakness in our approach as we apply the model at different scales. 

### Key References:

* Farquhar GD, Von Caemmerer S and Berry JA (1980) A
biochemical model of photosynthetic CO2 assimilation in leaves of C3 species. Planta 149: 78–90

***

# Temperature responses of model parameters

Let's start by exploring the response of the model to temperature. First we need to generate some temperature data:

```{r}
library(ggplot2)

source("R/photosynthesis.R")
source("R/parameters.R")
source("R/constants.R")

Tleaf <- seq(0.0, 50.0, 0.5) + DEG_2_KELVIN
```

The photosynthesis model has two major parameters, the potential rate of electron
transport (Jmax) and the maximum rate of Rubisco activity (Vcmax). Both of these parameters vary as a function of temperature, let's plot them. I've copied the function calls from photosynthes.R:

```{r}
Vcmax <- peaked_arrh(p$Vcmax25, p$Eav, Tleaf, p$deltaSv, p$Hdv)
Jmax <- peaked_arrh(p$Jmax25, p$Eaj, Tleaf, p$deltaSj, p$Hdj)

df <- data.frame(Tleaf, Vcmax, Jmax)

ggplot(df, aes(Tleaf-DEG_2_KELVIN)) +
  geom_line(aes(y=Vcmax, colour="Vcmax")) +
  geom_line(aes(y=Jmax, colour="Jmax")) +
  ylab(expression("Paramater" ~ (mu * mol ~  m^{-2}  ~  s^{-1}))) +
  xlab(expression('Temperature ('*~degree*C*')')) + 
  theme_classic() +
  theme(legend.title=element_blank()) +
  scale_colour_brewer(palette = "Set2")
```

In the model both parameters are modelled using a peaked form of the Arrhenius equation. The Eav/Eaj parameters give the exponential increase of the function below the optimum; the Hdv/Hdj parameters describe the rate of decrease of the function above the optimum. 

Let's see what values we used:  

```{r}
print(c(p$Vcmax25, p$Eav, p$deltaSv, p$Hdv))
print(c(p$Jmax25, p$Eaj, p$deltaSj, p$Hdj))
```

Let's tweak these values and see how our functions respond to temperature

```{r}
Vcmax <- peaked_arrh(p$Vcmax25, p$Eav, Tleaf, p$deltaSv, p$Hdv)
Vcmax2 <- peaked_arrh(p$Vcmax25, 40000, Tleaf, 620.0, p$Hdv)
Vcmax3 <- peaked_arrh(p$Vcmax25, 70000, Tleaf, 650.0, p$Hdv)


df <- data.frame(Tleaf, Vcmax, Jmax)

ggplot(df, aes(Tleaf-DEG_2_KELVIN)) +
  geom_line(aes(y=Vcmax, colour="Vcmax")) +
  geom_line(aes(y=Vcmax2, colour="Vcmax2")) +
  geom_line(aes(y=Vcmax3, colour="Vcmax3")) +
  ylab(expression("Vcmax" ~ (mu * mol ~  m^{-2}  ~  s^{-1}))) +
  xlab(expression('Temperature ('*~degree*C*')')) + 
  theme_classic() +
  theme(legend.title=element_blank()) +
  scale_colour_brewer(palette = "Set2")
```

In the model, the Rubisco-limited photosynthesis rate is made up of five paramaters: 

  1. $\Gamma$$^{*}$: the CO~2~ compensation point in the absence of mitochondrial respiration.
  2. V~cmax~: the maximum rate of Rubisco activity.
  3. R~d~: leaf mitochondrial respiration in the light (day respiration).
  4. K~o~: Michaelis– Menten coefficients for oxygenation.
  5. K~c~: Michaelis– Menten coefficients for carboxylation.
  
Each of these parameters is temperature dependent, thus the skill of the model depends on correctly accounting for these response to temperature when using the model. When we use these model parameters in global models we typical assume that the parameters (excluding V~cmax~) are conserved across species. This assumption is broadly supported by observations, but what do we think happens in different growing conditions? By contrast, leaf measurements suggest that V~cmax~ varies considerably: varying between leaves within a single plant, across growing seasons and across plants. In global models, we typically assume that we can represent this variability using 5-11 plant functional types, see Rogers, A. Photosynth Res (2014) 119: 15. https://doi.org/10.1007/s11120-013-9818-1 for more details. Even when we do this in models, the disagreement across models is striking.

```{r rogers, echo=FALSE, out.width = '40%', fig.align = "center"}
knitr::include_graphics("data/rogers.png")
```

Now that you've seen how to call the functions to calculate V~cmax~ and J~max~, can you look in the code (R/photosynthesis.R) and also plot $\Gamma$$^{*}$, R~d~m, K~o~ and K~m~ as a function of temperature?
  
***

# Response to temperature

From this understanding of how the two key model parameters change with temperature, can we make a prediction about how the rate of photosynthesis is likely to change with temperature? 

Let's make a plot to see if our predictions matched the models...

```{r}
Tleaf <- seq(0, 50.0, 0.5) + DEG_2_KELVIN
PAR <- 1800.0
Cs <- 400.0
vpd <- 1.5

out <- calc_photosynthesis(p, Tleaf, PAR, Cs, vpd, peaked_Vcmax=TRUE,
                           peaked_Jmax=TRUE)
df <- data.frame(Tleaf, out$An, out$Ac, out$Aj)

ggplot(df, aes(Tleaf-DEG_2_KELVIN)) +
  geom_line(aes(y=out.Ac, colour="Rubisco-limited (Ac)")) +
  geom_line(aes(y=out.Aj, colour="RuBP-limited (Aj)")) +
  ylab(expression("Photosynthesis" ~ (mu * mol ~  m^{-2}  ~  s^{-1}))) +
  xlab(expression('Temperature ('*~degree*C*')')) + 
  #theme_classic(base_size=16) +
  theme_classic() +
  theme(legend.title=element_blank()) +
  theme(legend.position = c(0.9, 0.9)) +
  scale_colour_brewer(palette = "Set2")

#if (dir.exists("plots") == FALSE) {
#  dir.create("plots")
#}
#ggsave("plots/Ac_Aj_temp.pdf", width=9, height=6) 
```



***

## Response to PAR

```{r}
Tleaf <- 25.0 + DEG_2_KELVIN
PAR <- seq(0, 2000.0, 0.5) 
Cs <- 400.0
vpd <- 1.5

out <- calc_photosynthesis(p, Tleaf, PAR, Cs, vpd, peaked_Vcmax=TRUE,
                           peaked_Jmax=TRUE)
df <- data.frame(PAR, out$An)

ggplot(df, aes(PAR, out.An)) +
  geom_line() +
  ylab(expression("Photosynthesis" ~ (mu * mol ~  m^{-2}  ~  s^{-1}))) +
  xlab(expression('PAR' ~ (mu * mol ~  m^{-2}  ~  s^{-1}))) +
  #theme_classic(base_size=16) +
  theme_classic() +
  theme(legend.title=element_blank()) +
  scale_colour_brewer(palette = "Set2")

#if (dir.exists("plots") == FALSE) {
#  dir.create("plots")
#}
#ggsave("plots/An_PAR.pdf", width=9, height=6) 
```
***

## Response to CO~2~

```{r}
Tleaf <- 25.0 + DEG_2_KELVIN
PAR <- 1800.0
Cs <- seq(100., 1000, 0.5) 
vpd <- 1.5

out <- calc_photosynthesis(p, Tleaf, PAR, Cs, vpd, peaked_Vcmax=TRUE,
                           peaked_Jmax=TRUE)
df <- data.frame(Cs, out$An, out$Ac, out$Aj, out$Rd)

ggplot(df, aes(Cs)) +
  geom_line(aes(y=out.Ac - out.Rd, colour="Ac"), size=1.0) +
  geom_line(aes(y=out.Aj - out.Rd, colour="Aj"), size=1.0) +
  geom_line(aes(y=out.An, color="An"), size=1.0) +
  ylab(expression("Photosynthesis" ~ (mu * mol ~  m^{-2}  ~  s^{-1}))) +
  xlab(expression('Ca' ~ (mu * mol ~ mol^{-1}))) +
  #theme_classic(base_size=16) +
  theme_classic() +
  theme(legend.title=element_blank()) +
  theme(legend.position = c(0.1, 0.9)) +
  scale_colour_brewer(palette = "Set2")

#if (dir.exists("plots") == FALSE) {
#  dir.create("plots")
#}
#ggsave("plots/An_CO2.pdf", width=9, height=6)  
```

***

## How good a model is it?

Compare to leaf level measurements...

***

## Flux stuff

Compare model to flux-derived GPP, what factors account for diff
***

## Global predictions

Can we build a simple global map of GPP with some simple assumptions....























Let's get some CO2 data to run the model with

```{r}
mauna_loa_co2 <- read.table('ftp://aftp.cmdl.noaa.gov/products/trends/co2/co2_annmean_mlo.txt')
names(mauna_loa_co2) <- c('year', 'co2ppm', 'unc')

ggplot(mauna_loa_co2, aes(year, co2ppm)) +
  geom_line() +
  ylab("CO2 (ppm)") +
  xlab('Year') + 
  theme_classic()
```


